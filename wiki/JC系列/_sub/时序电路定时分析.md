## 详见教参 42

---
### 时序电路定时分析：建立时间与保持时间约束详解

#### 一、时序电路的基本结构与定时挑战

- **电路构成**：时序电路由组合逻辑电路（处理数据）和触发器（存储状态）级联组成。
- **核心挑战**：确保触发器在时钟采样时，输入信号已稳定，避免亚稳态或逻辑错误。

#### 二、建立时间约束（Setup Time Constraint）

- **定义**：时钟周期（$T_c$）必须满足组合逻辑延迟与触发器延迟的时间匹配，避免采样时输入未稳定。
- **公式推导**：$t_{pd} \leq T_c - (t_{pcq} + t_{setup})$
    - $t_{pd}$：组合逻辑电路的传播延迟（前一级触发器 Q 端到后一级触发器 D 端的延迟）。
    - $t_{pcq}$：触发器的时钟到 Q 传播延迟（时钟边沿到 Q 端稳定的最长时间）。
    - $t_{setup}$：触发器的建立时间（时钟边沿前 D 端必须稳定的最小时间）。
- **物理意义**： 时钟周期需足够长，使得前一级触发器输出经组合逻辑处理后，能在当前时钟边沿前$t_{setup}$时间内稳定到后一级触发器的 D 端。
![[Pasted image 20250620211437.png]]
#### 三、保持时间约束（Hold Time Constraint）

- **定义**：确保时钟边沿后，触发器输入 D 端信号不会过早变化，避免采样值被破坏。
- **公式推导**：$t_{cd} \geq t_{hold} - t_{ccq}$
    - $t_{cd}$：组合逻辑电路的污染延迟（前一级触发器 Q 端到后一级触发器 D 端的最短延迟）。
    - $t_{hold}$：触发器的保持时间（时钟边沿后 D 端必须稳定的最小时间）。
    - $t_{ccq}$：触发器的时钟到 Q 污染延迟（时钟边沿到 Q 端开始变化的最早时间）。
- **关键条件**： 若$t_{hold} \leq t_{ccq}$，则$t_{cd} \geq 0$（天然满足），此时组合逻辑延迟无需额外约束，设计更灵活。
![[Pasted image 20250620211523.png]]
#### 四、定时约束的工程意义

- **系统时钟频率计算**： 由建立时间约束公式可得最大时钟频率：$f_{max} = \frac{1}{T_{c(min)}} = \frac{1}{t_{pd(max)} + t_{pcq} + t_{setup}}$ （$t_{pd(max)}$为组合逻辑最大延迟）。
- **设计优化方向**：
    - 减少$t_{pd}$：优化组合逻辑（如化简表达式、减少门级数）。
    - 选择高速触发器（更小的$t_{pcq}$、$t_{setup}$）。

#### 五、毛刺（Glitch）与定时的关系

- **关联点**：组合逻辑中的毛刺可能导致 D 端信号在触发器采样时出现非预期跳变，违反建立 / 保持时间约束。
- **解决方案**：
    - 通过 K-map 化简逻辑，消除质蕴涵项交界处的毛刺（如增加冗余项）。
    - 采用同步设计，利用触发器采样稳态值，过滤毛刺影响。

#### 六、案例：时序约束的实际应用

- **场景**：CPU 流水线中，指令从寄存器 R1 经 ALU（组合逻辑）到寄存器 R2。
- **参数示例**：
    - $t_{pd}$（ALU 延迟）= 3ns，$t_{pcq}$=1ns，$t_{setup}$=1ns。
    - 最小时钟周期$T_c = 3 + 1 + 1 = 5ns$，对应最大频率 200MHz。
- **违规后果**：若时钟频率超过 200MHz，R2 采样到未稳定的 ALU 输出，导致计算错误。